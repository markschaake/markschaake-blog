---
---

<div class="chart-container">
  <div class="chart-header">
    <div class="chart-title">Ratio vs Churn</div>
    <div class="chart-subtitle">7-day trailing ratio and 7-day file churn rate</div>
  </div>
  <canvas id="ratio-vs-churn-chart"></canvas>
</div>

<script>
  import { Chart, registerables } from 'chart.js';
  Chart.register(...registerables);

  const labels = [
    '1/11', '1/12', '1/13', '1/14', '1/15', '1/16', '1/17', '1/18',
    '1/19', '1/20', '1/21', '1/22', '1/23', '1/24', '1/25', '1/26',
    '1/27', '1/28', '1/29', '1/30', '1/31', '2/1', '2/2', '2/3',
    '2/4', '2/5', '2/6', '2/7', '2/8', '2/9', '2/10', '2/11',
    '2/12', '2/13', '2/14', '2/15', '2/16', '2/17', '2/18', '2/19',
  ];

  const wallHours = [
    0.5, 0, 3, 4.5, 5, 5.5, 8, 13,
    10, 3, 0, 3.5, 4, 5, 7, 6.5,
    3, 0, 2, 5, 6.5, 5, 7, 9,
    8, 4, 0, 0, 3, 4.5, 5.5, 4,
    5, 7, 8, 6, 8, 7.5, 5, 3,
  ];

  const machineHours = [
    0.5, 0, 3, 4.5, 5.5, 6, 11, 17,
    13, 3.5, 0, 3.5, 4, 5.5, 8.5, 7.5,
    3.5, 0, 2, 5.5, 7.5, 5.5, 9.5, 14,
    11, 5, 0, 0, 3.5, 5, 6.5, 5,
    7, 10, 11, 8, 13, 12, 8, 4,
  ];

  // Daily churn: fraction of files touched that were re-modified within 7 days
  // Low during well-planned bursts, spikes during rushed parallel execution
  const dailyChurnRaw = [
    0.08, 0, 0.10, 0.12, 0.11, 0.14, 0.18, 0.22,  // first burst: churn rises with throughput
    0.20, 0.10, 0, 0.08, 0.07, 0.09, 0.10, 0.11,   // recovery/planning: churn drops
    0.06, 0, 0.05, 0.07, 0.08, 0.07, 0.09, 0.11,   // well-planned burst: churn stays low
    0.10, 0.06, 0, 0, 0.05, 0.07, 0.08, 0.09,      // quiet period
    0.12, 0.16, 0.14, 0.11, 0.10, 0.09, 0.08, 0.06, // sustained work: churn controlled
  ];

  // Compute 7-day trailing ratio (same logic as MachineWallRatioChart)
  const windowSize = 7;
  const ratios: (number | null)[] = [];

  for (let i = 0; i < wallHours.length; i++) {
    if (wallHours[i] === 0 && machineHours[i] === 0) {
      ratios.push(null);
      continue;
    }
    let wallSum = 0;
    let machineSum = 0;
    let count = 0;
    for (let j = i; j >= 0 && count < windowSize; j--) {
      if (wallHours[j] > 0 || machineHours[j] > 0) {
        wallSum += wallHours[j];
        machineSum += machineHours[j];
        count++;
      }
    }
    ratios.push(wallSum > 0 ? Math.round((machineSum / wallSum) * 100) / 100 : null);
  }

  // Compute 7-day trailing churn average, skipping zero-activity days
  const churnRates: (number | null)[] = [];

  for (let i = 0; i < dailyChurnRaw.length; i++) {
    if (wallHours[i] === 0 && machineHours[i] === 0) {
      churnRates.push(null);
      continue;
    }
    let churnSum = 0;
    let count = 0;
    for (let j = i; j >= 0 && count < windowSize; j--) {
      if (wallHours[j] > 0 || machineHours[j] > 0) {
        churnSum += dailyChurnRaw[j];
        count++;
      }
    }
    churnRates.push(count > 0 ? Math.round((churnSum / count) * 1000) / 10 : null);
  }

  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
  const tickColor = isDark ? '#9ca3af' : '#6b7280';

  const ctx = document.getElementById('ratio-vs-churn-chart') as HTMLCanvasElement;

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Machine:Wall Ratio',
          data: ratios,
          borderColor: '#06b6d4',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 3,
          borderWidth: 2,
          spanGaps: true,
          yAxisID: 'y',
        },
        {
          label: '7-Day Churn Rate',
          data: churnRates,
          borderColor: '#f43f5e',
          backgroundColor: 'rgba(244, 63, 94, 0.1)',
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 3,
          borderWidth: 2,
          spanGaps: true,
          yAxisID: 'y1',
        },
        {
          label: 'Baseline (1.0)',
          data: Array(labels.length).fill(1.0),
          borderColor: isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.15)',
          borderDash: [6, 4],
          borderWidth: 1,
          pointRadius: 0,
          pointHoverRadius: 0,
          fill: false,
          yAxisID: 'y',
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2.5,
      interaction: {
        intersect: false,
        mode: 'index',
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: tickColor,
            usePointStyle: true,
            pointStyle: 'circle',
            padding: 20,
            font: { size: 12 },
            filter: (item) => item.text !== 'Baseline (1.0)',
          },
        },
        tooltip: {
          filter: (item) => item.dataset.label !== 'Baseline (1.0)',
          callbacks: {
            label: (context) => {
              if (context.dataset.yAxisID === 'y1') {
                return `${context.dataset.label}: ${context.parsed.y}%`;
              }
              return `${context.dataset.label}: ${context.parsed.y}x`;
            },
          },
        },
      },
      scales: {
        x: {
          grid: { color: gridColor },
          ticks: {
            color: tickColor,
            maxRotation: 0,
            autoSkip: true,
            maxTicksLimit: 10,
            font: { size: 11 },
          },
        },
        y: {
          position: 'left',
          grid: { color: gridColor },
          ticks: {
            color: '#06b6d4',
            callback: (value) => `${value}x`,
            font: { size: 11 },
          },
          min: 0.8,
          suggestedMax: 2.0,
        },
        y1: {
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: {
            color: '#f43f5e',
            callback: (value) => `${value}%`,
            font: { size: 11 },
          },
          min: 0,
          suggestedMax: 25,
        },
      },
    },
  });
</script>

<style>
  .chart-container {
    background-color: #1f2937;
    border-radius: 0.5rem;
    padding: 1.25rem 1.25rem 0.75rem;
    margin: 1.5rem 0;
  }

  .chart-header {
    padding: 0 0.25rem 0.75rem;
  }

  .chart-title {
    color: #f3f4f6;
    font-size: 0.9375rem;
    font-weight: 600;
    line-height: 1.4;
  }

  .chart-subtitle {
    color: #9ca3af;
    font-size: 0.8125rem;
    line-height: 1.4;
  }
</style>
